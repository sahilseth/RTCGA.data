---
title: "Using `RTCGA` package to download rna-seq data that are included in `RTCGA.rnaseq` package"
author: "Marcin KosiÅ„ski"
date: "`r Sys.Date()`"
output: 
   html_document:
      fig_width: 17
      fig_height: 10
      toc: true
      toc_depth: 3
      theme: readable
      highlight: pygments
      keep_md: true
      includes:
         in_header: include/in_header.html
         before_body: include/before_body.html
---

```{r, echo=FALSE}
library(knitr)
opts_chunk$set(comment="", message=FALSE, warning = FALSE, tidy.opts=list(keep.blank.line=TRUE, width.cutoff=150),options(width=150), cache=TRUE, eval = FALSE)
```

# RTCGA package

> The Cancer Genome Atlas (TCGA) Data Portal provides a platform for researchers to search, download, and analyze data sets generated by TCGA. It contains clinical information, genomic characterization data, and high level sequence analysis of the tumor genomes. The key is to understand genomics to improve cancer care.

`RTCGA` package offers download and integration of the variety and volume of TCGA data using patient barcode key, what enables easier data possession. This may have an benefcial infuence on impact on development of science and improvement of patients' treatment. `RTCGA` is an open-source R package, available to download from Bioconductor 

```{r, eval=FALSE}
source("http://bioconductor.org/biocLite.R")
biocLite("RTCGA")
```

or from github
```{r}
if (!require(devtools)) {
    install.packages("devtools")
    require(devtools)
}
install_github("MarcinKosinski/RTCGA")
```

Furthermore, `RTCGA` package transforms TCGA data to form which is convenient to use in R statistical package. Those data transformations can be a part of statistical analysis pipeline which can be more reproducible with `RTCGA`.

# How to download rna-seq data to gain the same datasets as in RTCGA.rnaseq package?

There are many available date times of TCGA data releases. To see them all just type:
```{r}
library(RTCGA)
checkTCGA('Dates')
```

Version 1.0.0 of `RTCGA.rnaseq` package contains rna-seq datasets from `2015-06-01`.
There were downloaded as follows:

## Available cohorts

All cohort names can be checked using:
```{r}
(cohorts <- infoTCGA() %>% 
   names() %>% 
   sub("-counts", "", x=.))
```

For all cohorts the following code downloads the rna-seq data.

## Downloading tarred files
```{r}
#dir.create( "data2" )
date <- "2015-06-01"
sapply( cohorts, function(element){
tryCatch({
downloadTCGA( cancerTypes = element, 
              dataSet = "rnaseqv2__illuminahiseq_rnaseqv2__unc_edu__Level_3__RSEM_genes_normalized__data.Level",
              destDir = "data2/", 
              date = date )},
error = function(cond){
   cat("Error: Maybe there weren't rnaseq data for ", element, " cancer.\n")
}
)
})
```

## Untarring downloaded files

```{r}
list.files( "data2/") %>% 
   paste0( "data2/", .) %>%
   grep( "tar.gz", x = ., value=TRUE) %>%
   sapply( untar, exdir = "data2/" )
```
## Removing no longer needed tar.gz files
After datasets are untarred, the `tar.gz` files ar no longer needed and can be deleted.

```{r}
list.files( "data2/") %>% 
   paste0( "data2/", .) %>%
   grep( pattern = "tar.gz", x = ., value = TRUE) %>%
   sapply( file.remove )

```

## Reading downloaded rna-seq datasets

### Shortening paths and directories 

```{r}
list.files( "data2/") %>% 
   paste0( "data2/", .) %>%
   file.rename( to = substr(.,start=1,stop=50))
```


### Paths to rna-seq data
Below is the code that automatically gives the path to `*rnaseqv2*` files for all cohorts types downloaded to `data2` folder.

```{r}
sapply( cohorts, function( element ){
   folder <- grep( paste0( "(_",element,"\\.", "|","_",element,"-FFPE)", ".*rnaseqv2"), 
                   list.files("data2/"),value = TRUE)
   file <- grep( paste0(element, ".*rnaseqv2"), list.files( paste0( "data2/",folder ) ),
                 value = TRUE)
   path <- paste0( "data2/", folder, "/", file )
   assign( value = path, x = paste0(element, ".rnaseq.path"), envir = .GlobalEnv)
}) 
```

### Reading rna-seq data 

Code is below


```{r}
sapply( cohorts, function(element){
   tryCatch({
    assign( value = readTCGA(get(paste0(element,".rnaseq.path"),
                                      envir = .GlobalEnv),
                          "rnaseq"),
            x = paste0(element, ".rnaseq"),
            envir = .GlobalEnv )
    },
   error=function(cond){
   cat("Error: Maybe there weren't rnaseq data for ", element, " cancer.\n")
})
})
```



# Saving rna-seq data to `RTCGA.rnaseq` package


```{r}
grep( "rnaseq", ls(), value = TRUE)[ -c(grep("path", grep( "rnaseq", ls(), value = TRUE)))] %>%
   cat( sep="," ) #can one to id better? as from use_data documentation:
   # ...	Unquoted names of existing objects to save
   devtools::use_data(ACC.rnaseq,BLCA.rnaseq,BRCA.rnaseq,CESC.rnaseq,CHOL.rnaseq,COAD.rnaseq,DLBC.rnaseq,ESCA.rnaseq,GBM.rnaseq,HNSC.rnaseq,KICH.rnaseq,KIPAN.rnaseq,KIRC.rnaseq,KIRP.rnaseq,LAML.rnaseq,LGG.rnaseq,LIHC.rnaseq,LUAD.rnaseq,LUSC.rnaseq,MESO.rnaseq,OV.rnaseq,PAAD.rnaseq,PCPG.rnaseq,PRAD.rnaseq,READ.rnaseq,SKCM.rnaseq,STES.rnaseq,TGCT.rnaseq,THCA.rnaseq,THYM.rnaseq,UCEC.rnaseq,UCS.rnaseq,UVM.rnaseq, overwrite = TRUE)
```

